YUI.add("hermes-template-photo-charm-contexts",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression;return s+='<div class="sets-context-views"></div>\n<div class="groups-context-views"></div>\n<div class="galleries-context-views"></div>\n<div class="context-views"></div>\n<div class="photostream-context-view"></div>\n<div class="view-all-contexts hidden">\n	<span class="view-all-contexts-header">',(o=n["view-all-string"])?o=o.call(t,{hash:{},data:i}):(o=t["view-all-string"],o=typeof o===u?o.apply(t):o),s+=a(o)+"</span>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/photo-charm-contexts",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-photo-charm-all-contexts",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function l(e,t){var r="",i;r+='\n	<li>\n		<a href="',(i=n.url)?i=i.call(e,{hash:{},data:t}):(i=e.url,i=typeof i===u?i.apply(e):i),r+=a(i)+'">',(i=n.title)?i=i.call(e,{hash:{},data:t}):(i=e.title,i=typeof i===u?i.apply(e):i),r+=a(i)+" ",i=n["if"].call(e,e.displayType,{hash:{},inverse:f.noop,fn:f.program(2,c,t),data:t});if(i||i===0)r+=i;return r+="</a>\n	</li>\n",r}function c(e,t){var r="",i;return r+="(",(i=n.displayType)?i=i.call(e,{hash:{},data:t}):(i=e.displayType,i=typeof i===u?i.apply(e):i),r+=a(i)+")",r}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression,f=this;s+='<ul class="view-all-context-list">\n',o=n.each.call(t,t.contexts,{hash:{},inverse:f.noop,fn:f.program(1,l,i),data:i});if(o||o===0)s+=o;return s+="\n</ul>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/photo-charm-all-contexts",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("photo-charm-contexts-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.get("container").html===""&&this.setContainerHTML(""),this},loadState:function(){var t=this;return e.batch(t.appContext.getModel("photo-models",this.photoId),t.appContext.getModel("photo-contexts-models",this.photoId)).then(function(e){t.set("photo",e[0]),t.set("photo-contexts",e[1])})},buildContainer:function(){var e;return e=this.templates("photo-charm-contexts")({"view-all-string":"View all contexts"}),this.setContainerHTML(e),this},activate:function(){var e=this,t=[],n=this.get("photo-contexts"),r,i=this.get("container").one(".view-all-contexts");return t=n.registry.getContextsNotOfType(n.id,"photostream-models"),e.totalContexts=t.length,e.maxContextsToShow=9,t.length===10&&(e.maxContextsToShow=10),t=this.orderContexts(t),e.deferContextLoading(t.slice(0,e.maxContextsToShow),function(t){return e.activateContext(t)}),r=n.registry.getContextsOfType(n.id,"photostream-models"),r.length>0&&e.activateContext(r[0],"photostream-view"),this.registerEventHandler(n.on("valuesChanged",e.handleContextChanges.bind(e))),i&&(e.totalContexts>e.maxContextsToShow?i.removeClass("hidden"):i.addClass("hidden"),this.registerEventHandler(i.one(".view-all-contexts-header").on("click",e.showFullContextList.bind(e)))),this},orderContexts:function(e){var t={set:0,group:1,gallery:2};return e.sort(function(e,n){var r=t[e.getValue("displayType")]||3,i=t[n.getValue("displayType")]||3;return r<i?1:r>i?-1:0}),e},handleContextChanges:function(e){var t=this.get("container"),n=e.contexts&&e.contexts.prevVal,r=e.contexts&&e.contexts.newVal&&e.contexts.newVal.getList(),i=this.get("photo-contexts"),s,o,u,a=this.get("container").one(".view-all-contexts");n&&n.length>0&&(n.length>r.length?(s=this.diffContextLists(r,n).removed[0].id,t.one('.context-view[data-context-id="'+s+'"]')&&t.one('.context-view[data-context-id="'+s+'"]').remove()):(u=i.registry.getContextsNotOfType(i.id,"photostream-models"),u.length<=this.maxContextsToShow?(o=this.diffContextLists(r,n).added[1],this.activateContext(o)):a.addClass("hidden")))},showFullContextList:function(){if(this.totalContexts>this.maxContextsToShow){var e=this.get("container").one(".view-all-contexts"),t=e.one(".view-all-contexts-header"),n=this.get("photo-contexts"),r=n.registry.getContextsNotOfType(n.id,"photostream-models"),i,s=this,o;t.hide(),r=this.orderContexts(r).slice(this.maxContextsToShow),i=this.templates("photo-charm-all-contexts")({contexts:r.map(function(e){return o=e.toJSON(),o.displayType==="set"&&s.appContext.flipper.isFlipped("rename-set-to-album")&&(o.displayType="album"),["photostream","favorites","related favorites","photos of","contacts"].indexOf(o.displayType)>-1&&(o.displayType=null),o})}),e.one(".view-all-context-list")&&e.one(".view-all-context-list").remove(),e.append(i)}},diffContextLists:function(t,n){var r={added:[],removed:[]};return e.Array.each(t,function(t){e.Array.indexOf(n,t)===-1&&r.added.push(t)}),e.Array.each(n,function(n){e.Array.indexOf(t,n)===-1&&r.removed.push(n)}),r},deferContextLoading:function(t,n){var r=this,i=4;t.length<i?e.Array.each(t,function(e){n.call(r,e)}):e.batch.apply(this,t.slice(0,i).map(function(e){return n.call(r,e)})).then(function(){r.isActiveAndInDOM()&&r.deferContextLoading(t.slice(i),n)})},activateContext:function(t,n){var r=this,i=t.registry.name==="photostream-models",s=e.URLHelper.parseContextURL(t.getValue("urlSuffix"),r.get("photo").getValue("owner").getValue("nsid")||r.get("photo").getValue("owner").getValue("pathAlias"),this.appContext),o={},u=r.totalContexts&&r.totalContexts>r.maxContextsToShow?12:24,a=8,f=r.totalContexts&&r.totalContexts>r.maxContextsToShow?8:16,l=4,c,h;return s&&s.params&&(o=s.params),o=e.merge(o,{id:t.id}),this.photosLoadedInContexts=[],r.appContext.getView("context-view",{nsid:r.nsid,photoId:r.photoId,context:{modelName:t.registry.name,params:o},perPage:i?u:a,displayNum:i?f:l,usePageFetcher:this.appContext.flipper.isFlipped("context-slider")||!i,numPrev:0,numNext:f}).then(function(s){return r.subviews[n||e.guid("context-view")]=s,s.registerEventHandler(s.on("flickr:photo-charm-contexts-view--track-context-photos",function(e){var t=e.details[0],n,o=[],u=i?f:l,a=r.photosLoadedInContexts.length+0;if(!t)return[];n=t.pop();while(n&&r.photosLoadedInContexts.length<a+u)r.photosLoadedInContexts.indexOf(n)>-1?o.push(n):r.photosLoadedInContexts.push(n),n=t.pop();n&&r.photosLoadedInContexts.length>a+u&&o.push.apply(o,[n].concat(t)),s.fire("flickr:photo-charm-contexts-view--duplicate-context-photos",o)})),s.initialize().then(function(){c=r.get("container"),h=s.get("container"),n==="photostream-view"?c.one(".photostream-context-view")&&c.one(".photostream-context-view").append(h):t.registry.name==="set-models"?c.one(".sets-context-views")&&c.one(".sets-context-views").append(h):t.registry.name==="groups-pool-models"?c.one(".groups-context-views")&&c.one(".groups-context-views").append(h):t.registry.name==="gallery-models"?c.one(".galleries-context-views")&&c.one(".galleries-context-views").append(h):c.one(".context-views")&&c.one(".context-views").append(h)})}).then(null,function(e){console.error(String(e),e)})}})},"@VERSION@",{requires:["flickr-view","hermes-template-photo-charm-contexts","hermes-template-photo-charm-all-contexts","photo-charms-contexts-css","url-helper"],optional:[]});
