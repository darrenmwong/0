YUI.add("photo-route",function(e){function t(e){t.superclass.constructor.call(this,e)}t.entryPaths={accept:[{name:"activity feed",pattern:/^\/$/},{name:"photostream",pattern:/^\/photos\/[^\/]+(\/with\/.+)?\/?$/},{name:"set",pattern:/^\/photos\/[^\/]+\/sets\//},{name:"contacts list",pattern:/^\/photos\/[^\/]+\/friends\/?/},{name:"favorites",pattern:/^\/photos\/[^\/]+\/favorites\/?/},{name:"gallery",pattern:/^\/photos\/[^\/]+\/galleries\/?/},{name:"profile",pattern:/^\/people\/[^\/]+\//},{name:"explore",pattern:/^\/explore\/?/},{name:"commons",pattern:/^\/commons\/?/},{name:"group",pattern:/^\/groups\/?/},{name:"gallery",pattern:/^\/galleries\/?/},{name:"map",pattern:/^\/map\/?/},{name:"search",pattern:/^\/search\/?/}]},e.Routes[this.name]=t,e.extend(t,e.FlickrRoute,{run:function(t,n){t.params.anything&&t.params.anything.match(/^(comment[0-9]+$)/)&&n.redirect(t.url.replace(/comment[0-9]+/,"")+"#"+t.params.anything.match(/^(comment[0-9]+$)/)[0]);var r=this,i=t.params.nsid_or_path_alias,s=t.params.photo_id,o=t.params.context,u=t.params.anything==="lightbox",a={id:s},f="welcome"in t.query,l;return e.TypeValidator.matches.nsid(i)?a.userId=i:a.pathAlias=i,l=r.parseContext(o,i,t),this.appContext.flipper.isFlipped("get-context-photos-in-photo-page-route")&&(l&&l.params&&l.modelName&&l.modelName!=="photostream-models"?a.context=o:a.context="photostream"),this.appContext.getModel("photo-models",a).then(function(n){var s,o,a,c,h,p,d=u?"photo-page-lightbox-view":"photo-page-view";s=r.verifyPhotoIsViewable(n,t),p=r.detectRouteErrors(s);if(p.length)return r.displayRouteErrors(t,p);o=r.verifyPhotoIsOwnedByPerson(n,i),p=r.detectRouteErrors(o);if(p.length)return r.displayRouteErrors(t,p);r.detectPointOfEntry(t,{person:i,photoId:s});if(p.length)return r.displayRouteErrors(t,p);if(r.appContext.adManager.isEnabled()&&r.appContext.adManager.adNext()){c=r.appContext.adManager.getAdJSON();if(c&&e.Lang.isObject(c))return a=c.brand||"",{view:"photo-page-ad-view",params:{ad:!0,photoId:s,nsid:o,context:l,closeUrl:r.getEntryPath()},title:a};r.appContext.fatal("Could not extract brand name from brand payload",{ad:c})}if(YUI.Env.isServer&&r.appContext.flipper.isFlipped("older-ie-fallback")){h=YUI.Env.parseUA(t.headers["user-agent"]);if(h.ie&&h.ie<=9)return{view:"minimal-photo-page-view",params:{photoId:s,nsid:o,context:l,closeUrl:r.getEntryPath()},title:n.getValue("title")||"Untitled"}}return r.appContext.flipper.isFlipped("enable-scrappy-photo-page")&&!u&&(d="photo-page-scrappy-view"),{view:d,params:{photoId:s,nsid:o,context:l,showWelcomeDialog:f,closeUrl:r.getEntryPath(),entryType:r.getEntryType(),fullscreen:u},title:n.getValue("title")||"Untitled"}},function(n){var i="Couldn't load photo page";return n.message&&(i+=": "+n.message),n.code===1?(e.Fletrics.increment("route.photo.route.404"),r.displayRouteErrors(t,new e.RouteError(404,i))):n.fatal?(e.Fletrics.increment("route.photo.route.500"),r.displayRouteErrors(t,new e.RouteError(500,i))):(e.Fletrics.increment("route.photo.route.404"),r.displayRouteErrors(t,new e.RouteError(404,i)))})},verifyPhotoIsViewable:function(t,n){var r=t.getValue("id"),i,s;return e.TypeValidator.matches.photoId(r)?(i="photo_privacy_is_viewable"in n.query?Number(n.query.photo_privacy_is_viewable):!0,s="photo_content_is_safe"in n.query?Number(n.query.photo_content_is_safe):!0,i?s?r:new e.RouteError(404,"Photo is unfit for your eyes. Have a kitten: (^._.^)\uff89"):new e.RouteError(403,"Private photo")):new e.RouteError(404,"No photo found with id "+r)},verifyPhotoIsOwnedByPerson:function(t,n){var r=t.getValue("id"),i=e.TypeValidator.matches.nsid(n);return n===t.getValue("owner").getValue(i?"id":"pathAlias")?t.getValue("owner").getValue("id"):new e.RouteError(404,"Photo "+r+" is not owned by "+n)},parseContext:function(t,n,r){t=t||"photostream";var i=e.URLHelper.parseContextURL(t,n,this.appContext);return r.url.match(/\/in\//)||(i=e.URLHelper.parseContextURL("photostream",n,this.appContext)),i},detectPointOfEntry:function(n,r){var i,s,o=this.appContext.flapp&&this.appContext.flapp.get("activeView"),u,a=t.entryPaths;if(e.config.flickr.homerun&&(e.config.flickr.ycParam||n.query&&n.query.yc)){s=e.config.flickr.ycParam?e.config.flickr.ycParam:n.query.yc;if(e.config.flickr.homerun.yc.indexOf(s.replace(/https?\:\/\//,""))!==-1){s.match(/https?:/)?this.setEntryPath(s):this.setEntryPath("https://"+s),this.setEntryType("Yahoo");return}}if(o)if(o.name==="photo-page-scrappy-view"||o.name==="photo-page-view"||o.name==="photo-page-lightbox-view"||o.name==="photo-page-ad-view"||o.name==="minimal-photo-page-view"){if(o.closeUrl){if(/photos\/([^\/.]*)\/with\/([0-9]+)/.test(o.closeUrl)){this.setEntryPath("/photos/"+r.person+"/with/"+r.photoId),this.setEntryType("photostream");return}this.setEntryPath(o.closeUrl),this.setEntryType(o.entryType);return}}else if(this.appContext.clientReferrer){if(this.appContext.clientReferrer===e.config.win.location.pathname+e.config.win.location.search+e.config.win.location.hash){this.setEntryPath("/photos/"+r.person+"/with/"+r.photoId),this.setEntryType("photostream");return}this.setEntryPath(this.appContext.clientReferrer);for(u=0;u<a.accept.length;u++)if(a.accept[u].pattern.test(this.appContext.clientReferrer)){this.setEntryType(a.accept[u].name);return}return}YUI.Env.isServer?i=n.headers.referrer||n.headers.referer:(i=document.referrer,e.UA.ie&&document.referrer===""&&(i=this.appContext.referrer)),/^https?:\/\/[^\/]*flickr\.com/.test(i)||(i=null),i&&i.indexOf("http")!==-1&&(i="/"+i.split("/").slice(3).join("/"));for(u=0;u<a.accept.length;u++)if(a.accept[u].pattern.test(i)){this.setEntryPath(i),this.setEntryType(a.accept[u].name);return}if(r.person&&r.photoId){this.setEntryPath("/photos/"+r.person+"/with/"+r.photoId),this.setEntryType("photostream");return}this.setEntryPath("/"),this.setEntryType("home")},setEntryPath:function(e){if(YUI.Env.isServer)return this._entryPath=e;t._entryPath=e},setEntryType:function(e){if(YUI.Env.isServer)return this._entryType=e;t._entryType=e},getEntryPath
:function(){return YUI.Env.isServer?this._entryPath:t._entryPath},getEntryType:function(){return YUI.Env.isServer?this._entryType:t._entryType}})},"@VERSION@",{requires:["flickr-route","type-validator","url-helper","fletrics"],optional:["photo-models","photo-page-view","photo-page-lightbox-view","photo-page-scrappy-view"]});
YUI.add("photo-head-meta-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{initializer:function(e){return this.photoId=e.photoId,this},subviewConfig:{},buildContainer:function(){return this},loadState:function(){var t=this;return e.batch(t.appContext.getModel("photo-head-meta-models",t.photoId),t.appContext.getModel("photo-models",t.photoId)).then(function(e){t.set("photo-meta",e[0]),t.set("photo",e[1])})},buildHeadContainer:function(){var t=this.get("photo-meta"),n=this.get("photo"),r=e.url(),i=t.getFieldsForDisplay(),s="",o=this,u=[{id:"canonicalurl",rel:"canonical",href:r+n.getValue("url")},{rel:"alternative",type:"application/json+oembed",href:r+"/services/oembed?url="+encodeURI(r+n.getValue("url"))+"&format=json",title:n.getValue("title")},{rel:"alternative",type:"text/xml+oembed",href:r+"/services/oembed?url="+encodeURI(r+n.getValue("url"))+"&format=xml",title:n.getValue("title")}];return Object.keys(i).forEach(function(e){typeof i[e]=="object"&&e==="pinterest"?s+=o.templates("head-meta")({metaName:e,noPin:!0,metaValue:i[e].nopin,metaDescription:i[e].reason})+"\n":s+=o.templates("head-meta")({metaName:e,metaValue:i[e]})+"\n"}),u.forEach(function(e){e.addedBy=o.name,s+=o.templates("head-link")(e)+"\n"}),this.set("headContainer",s),this}})},"@VERSION@",{requires:["flickr-view","hermes-template-head-meta","hermes-template-head-link"],optional:["photo-head-meta-models","photo-route","url"]});
YUI.add("photo-privacy-models",function(e){function t(e){t.superclass.constructor.call(this,e)}e.Models[this.name]=t,e.extend(t,e.FlickrModelRegistry,{name:this.name,remote:{read:function(t){return e.ModelFetchers["flickr-photos-getInfo"].run(t,this.appContext)},update:function(t,n){var r;return r={photo_id:t,is_public:this.getValue(t,"isPublic"),is_friend:this.getValue(t,"isVisibleByFriends"),is_family:this.getValue(t,"isVisibleByFamily"),perm_addmeta:this.getValue(t,"permAddMeta"),perm_comment:this.getValue(t,"permComment")},e.ModelUpdaters["flickr-photos-setPerms"].run(r,this.appContext)}},attributes:{isPublic:{validator:function(t){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)},defaultValue:!1},isVisibleByFriends:{validator:function(t){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)},defaultValue:!1},isVisibleByFamily:{validator:function(t){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)},defaultValue:!1},permAddMeta:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0},permComment:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-photos-getPerms-fetcher","flickr-photos-setPerms-updater","attribute-helpers"]});
YUI.add("flickr-photos-getPerms-fetcher",function(e){"use strict";function t(e,t){var n=e[0],r=e[1],i;i={id:t.id,isPublic:n.perms.ispublic,isVisibleByFriends:n.perms.isfriend,isVisibleByFamily:n.perms.isfamily,permAddMeta:n.perms.permaddmeta,permComment:n.perms.permcomment},r.exists(t.id)||r.add(i)}function n(t,n){var r=t.id,i={photo_id:r},s=this;return e.batch(n.callAPI("flickr.photos.getPerms",i),n.getModelRegistry("photo-privacy-models")).then(function(e){return s._processResponse(e,t)},function(e){throw n[e.fatal?"error":"debug"]("[flickr-photos-getPerms-fetcher] failed getting or processing API response:",e),e})}e.namespace("ModelFetchers")["flickr-photos-getPerms"]={run:n,_processResponse:t}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["photo-privacy-models"]});
